const express = require('express');
const fetch = require('node-fetch');
const qs = require('querystring');

const app = express();

const CLIENT_ID = '1434242083425878086';
const CLIENT_SECRET = 'xt7ZWPfnXeUR-MGZRGRfagnDzwuqICA0';
const REDIRECT_URI = 'http://aafatgaming.fun/';
const WEBHOOK_URL = 'https://discord.com/api/webhooks/1436807166441947326/TDsteagPEvUWZ6doblqvalWHKmafWGrdMsguSz_XBITklWx6uy-p6WpjUO2HBcefkkSC';

app.get('/auth/discord', (req, res) => {
  const params = qs.stringify({
    client_id: CLIENT_ID,
    redirect_uri: REDIRECT_URI,
    response_type: 'code',
    scope: 'identify',
    prompt: 'none'
  });
  res.redirect(`https://discord.com/api/oauth2/authorize?${params}`);
});

app.get('/auth/discord/callback', async (req, res) => {
  const code = req.query.code;
  
  // Exchange code for token
  const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: qs.stringify({
      client_id: CLIENT_ID,
      client_secret: CLIENT_SECRET,
      grant_type: 'authorization_code',
      code: code,
      redirect_uri: REDIRECT_URI
    })
  });
  const tokenData = await tokenResponse.json();
  const accessToken = tokenData.access_token;

  // Fetch user profile
  const userResponse = await fetch('https://discord.com/api/users/@me', {
    headers: {
      Authorization: `Bearer ${accessToken}`
    }
  });
  const userData = await userResponse.json();

  // Send login log to Discord Webhook
  await fetch(WEBHOOK_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      content: `New login:\nUsername: ${userData.username}#${userData.discriminator}\nID: ${userData.id}\nProfile: ${userData.avatar}\nLogin Time: ${new Date().toISOString()}`,
      avatar_url: `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`
    })
  });

  res.send(`Hello, ${userData.username}! You are logged in.`);
});

app.listen(3000, () => {
  console.log('Server running on http://localhost:3000');
});
